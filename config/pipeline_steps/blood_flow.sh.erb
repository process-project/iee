#!/bin/bash -l
#SBATCH -N 1
#SBATCH --ntasks-per-node=24
#SBATCH --time=00:15:00
#SBATCH -A <%= grant_id %>
#SBATCH -p plgrid
#SBATCH --output /net/archive/groups/plggeurvalve/slurm_outputs/slurm-%j.out
#SBATCH --error /net/archive/groups/plggeurvalve/slurm_outputs/slurm-%j.err

## Change to the directory where sbatch was called
cd $SCRATCHDIR

export SSH_DOWNLOAD_KEY="<%= ssh_download_key %>"
ssh-agent bash -c 'ssh-add <(echo "$SSH_DOWNLOAD_KEY"); git clone git@gitlab.com:eurvalve/blood-flow.git'

cd blood-flow
git reset --hard <%= revision %>
cd ..

## Copy the template file structure over
cp blood-flow/* .

## Copy both fluid and structure files for the given case
<%= stage_in :fluid_virtual_model, 'fluidFlow.cas' %>
<%= stage_in :ventricle_virtual_model, 'structural_vent.dat' %>

./run_coupled_bashscript.sh

cd FluidFlow
OUT_FILE_1=`ls -t fluidFlow-1-* | head -1`
OUT_FILE_2=`ls -t fluidFlow-1-* | head -2 | tail -1`

<%= stage_out('$OUT_FILE_1') %>
<%= stage_out('$OUT_FILE_2') %>
